#!/usr/bin/env bash
set -euo pipefail

PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ ! -d "${PLUGIN_DIR}/node_modules" ]; then
  (cd "${PLUGIN_DIR}" && CI=1 pnpm install --prod --frozen-lockfile)
fi

# Run the provider server entrypoint (compiled JS).
# IMPORTANT: do not write anything to stdout from here.
# Forward Pulumi's engine address/flags to the provider.
exec node "${PLUGIN_DIR}/dist/plugin/provider.js" "$@"
